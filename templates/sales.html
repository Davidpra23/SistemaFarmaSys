{% extends "base.html" %}

{% block title %}Punto de Venta{% endblock %}

{% block content %}
<div x-data="salesPOS()" x-init="init()" class="container-fluid p-4">

  <div class="row">

    <!-- COLUMNA IZQUIERDA (C√°mara + Carrito) -->
    <div class="col-md-6 order-1">

      <!-- ESC√ÅNER ARRIBA - C√ÅMARA PEQUE√ëA -->
      <div class="card bg-dark text-white shadow-sm mb-3 overflow-hidden" style="max-width: 240px;">
        <div
          class="card-body p-2 text-center position-relative d-flex justify-content-center align-items-center bg-black"
          style="min-height: 220px;">

          <div class="scanner-container">
            <div id="reader"></div>
          </div>

          <!-- Bot√≥n c√°mara -->
          <div x-show="!scannerActive" class="position-absolute top-50 start-50 translate-middle w-100"
            style="z-index: 20;">
            <button class="btn btn-primary btn-sm shadow" @click="startScanner()">
              <i class="fas fa-camera me-1"></i> Activar
            </button>
          </div>

          <!-- Feedback -->
          <div id="scan-message"
            style="position: absolute; bottom: 10px; left: 0; right: 0; text-align: center; display: none; z-index: 10;">
            <span class="badge bg-success p-1 fs-6 shadow">OK</span>
          </div>
        </div>
      </div>

      <!-- CARRITO ABAJO DE LA C√ÅMARA -->
      <div class="card shadow h-100 border-0">
        <div class="card-header bg-primary text-white py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Carrito</h5>
            <span class="badge bg-light text-primary fs-6" x-text="cart.reduce((a, b) => a + b.qty, 0)"></span>
          </div>
        </div>

        <!-- Lista de Items del Carrito -->
        <div class="card-body p-0 bg-light d-flex flex-column" style="height: calc(100vh - 280px); overflow-y: auto;">
          
          <!-- Estado Vac√≠o -->
          <div x-show="cart.length === 0" class="text-center text-muted p-5 my-auto">
            <div class="mb-3">
              <i class="fas fa-receipt fa-4x text-secondary opacity-25"></i>
            </div>
            <h5>El carrito est√° vac√≠o</h5>
            <p class="small">Escanea un producto o selecciona de la lista.</p>
            <button class="btn btn-outline-primary mt-2" @click="focusSearch()">
              <i class="fas fa-search me-1"></i>Buscar
            </button>
          </div>

          <!-- Tabla de Items -->
          <div x-show="cart.length > 0" class="flex-grow-1">
            <div class="table-responsive">
              <table class="table table-hover align-middle mb-0">
                <thead class="table-light sticky-top">
                  <tr>
                    <th class="ps-3">Producto</th>
                    <th class="text-center">Precio</th>
                    <th class="text-center">Cantidad</th>
                    <th class="text-center">Total</th>
                    <th class="text-end pe-3">Eliminar</th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="(item, index) in cart" :key="index">
                    <tr x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 transform -translate-y-2"
                        x-transition:enter-end="opacity-100 transform translate-y-0">
                      <!-- Producto -->
                      <td class="ps-3">
                        <div class="fw-bold text-dark" x-text="item.name"></div>
                        <small class="text-muted" x-show="item.stock - item.qty <= 5 && item.stock - item.qty > 0">
                          <span x-text="item.stock - item.qty"></span> restantes
                        </small>
                      </td>
                      
                      <!-- Precio Unitario -->
                      <td class="text-center">
                        <span class="fw-bold text-primary">$<span x-text="item.price.toFixed(2)"></span></span>
                      </td>
                      
                      <!-- Cantidad -->
                      <td class="text-center">
                        <div class="d-flex flex-row align-items-center justify-content-center gap-1">
                          <button class="btn btn-outline-secondary btn-sm rounded-circle d-flex align-items-center justify-content-center" 
                                  style="width: 28px; height: 28px;" 
                                  @click="updateQty(index, -1)">
                            <i class="fas fa-minus" style="font-size: 0.7rem;"></i>
                          </button>
                          
                          <span class="fw-bold fs-6 mx-1" style="min-width: 24px;" x-text="item.qty"></span>
                          
                          <button class="btn btn-outline-secondary btn-sm rounded-circle d-flex align-items-center justify-content-center" 
                                  style="width: 28px; height: 28px;" 
                                  @click="updateQty(index, 1)"
                                  :class="{'btn-success': item.qty < item.stock, 'btn-warning': item.qty >= item.stock}">
                            <i class="fas fa-plus" style="font-size: 0.7rem;"></i>
                          </button>
                        </div>
                        
                        <!-- Barra de progreso de stock -->
                        <div class="progress mt-1 mx-auto" style="height: 3px; width: 60px;" x-show="item.stock > 0">
                          <div class="progress-bar" 
                               :class="item.qty/item.stock > 0.8 ? 'bg-warning' : 'bg-success'"
                               :style="`width: ${(item.qty/item.stock)*100}%`"></div>
                        </div>
                      </td>
                      
                      <!-- Total -->
                      <td class="text-center">
                        <span class="fw-bold text-dark fs-6">$<span x-text="(item.price * item.qty).toFixed(2)"></span></span>
                      </td>
                      
                      <!-- Eliminar -->
                      <td class="text-end pe-3">
                        <button class="btn btn-sm text-danger hover-bg-light rounded-circle p-2" 
                                @click="removeItem(index)"
                                style="width: 36px; height: 36px;"
                                title="Eliminar producto">
                          <i class="fas fa-trash-alt" style="font-size: 0.9rem;"></i>
                        </button>
                      </td>
                    </tr>
                  </template>
                </tbody>
              </table>
            </div>
          </div>

        </div>

        <!-- Footer: Totales y Acciones -->
        <div class="card-footer bg-white border-top p-4 shadow-lg" style="z-index: 5;">
          <div class="row mb-3">
            <div class="col-6">
              <div class="text-muted small">Art√≠culos:</div>
              <div class="fw-bold fs-5" x-text="cart.reduce((a, b) => a + b.qty, 0)"></div>
            </div>
            <div class="col-6 text-end">
              <button class="btn btn-outline-danger btn-sm" @click="cart = []" x-show="cart.length > 0">
                <i class="fas fa-trash-alt me-1"></i> Vaciar
              </button>
            </div>
          </div>
          
          <div class="border-top pt-3">
            <div class="d-flex justify-content-between mb-2 text-muted small">
              <span>Subtotal:</span>
              <span class="fw-bold">$<span x-text="totalCart()"></span></span>
            </div>
            
            <div class="d-flex justify-content-between mb-2 text-muted small">
              <span>IVA (16%):</span>
              <span class="fw-bold">$<span x-text="(totalCart() * 0.16).toFixed(2)"></span></span>
            </div>

            <div class="d-flex justify-content-between mb-4 align-items-end">
              <span class="h4 mb-0 text-dark">Total:</span>
              <span class="display-6 mb-0 text-primary fw-bold">$<span x-text="(totalCart() * 1.16).toFixed(2)"></span></span>
            </div>

            <button
              class="btn btn-success w-100 py-3 fw-bold shadow-sm text-uppercase d-flex align-items-center justify-content-center gap-2"
              @click="checkout()" 
              :disabled="cart.length === 0 || processing"
              :class="{'btn-success': cart.length > 0, 'btn-secondary': cart.length === 0}">
              <span x-show="!processing"><i class="fas fa-money-bill-wave"></i> Proceder al Pago</span>
              <span x-show="processing"><i class="fas fa-spinner fa-spin"></i> Procesando...</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- COLUMNA DERECHA (Lista de Productos) -->
    <div class="col-md-6 order-2">
      <!-- LISTA DE PRODUCTOS -->
      <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
          <div class="input-group">
            <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
            <input type="text" id="product-search" class="form-control border-start-0 bg-light"
              placeholder="Buscar por nombre o c√≥digo..." x-model="searchQuery" @keydown.enter="manualAdd()">
            <button class="btn btn-outline-secondary" @click="searchQuery = ''" x-show="searchQuery">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="card-body p-0" style="height: 450px; overflow-y: auto;">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light sticky-top">
              <tr>
                <th class="ps-4">Producto</th>
                <th>C√≥digo</th>
                <th>Precio</th>
                <th>Stock</th>
                <th class="text-end pe-4">Acci√≥n</th>
              </tr>
            </thead>

            <tbody>

              <tr x-show="loading">
                <td colspan="5" class="text-center py-5">
                  <div class="spinner-border text-primary" role="status"></div>
                  <p class="text-muted mt-2">Cargando inventario...</p>
                </td>
              </tr>

              <template x-for="p in filteredProducts()" :key="p.id">
                <tr class="product-row" 
                    :class="{'table-danger': p.stock <= 0, 'bg-light': p.stock <= 0}">
                  <td class="ps-4">
                    <div class="fw-bold text-truncate" style="max-width: 200px;" x-text="p.name"></div>
                    <small class="text-muted" x-text="p.category"></small>
                  </td>

                  <td><span class="badge bg-light text-dark border font-monospace" x-text="p.sku"></span></td>

                  <td class="fw-bold text-primary">$<span x-text="p.price.toFixed(2)"></span></td>

                  <td>
                    <span class="badge rounded-pill"
                      :class="p.stock > 10 ? 'bg-success' : (p.stock > 0 ? 'bg-warning text-dark' : 'bg-danger')"
                      x-text="p.stock > 0 ? p.stock : 'Agotado'"></span>
                  </td>

                  <td class="text-end pe-4">
                    <button class="btn btn-sm btn-outline-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center"
                      @click="addToCart(p)" :disabled="p.stock <= 0" style="width: 32px; height: 32px; padding: 0;">
                      <i class="fas fa-plus" style="font-size: 0.8rem;"></i>
                    </button>
                  </td>
                </tr>
              </template>

              <tr x-show="!loading && filteredProducts().length === 0">
                <td colspan="5" class="text-center py-5 text-muted">
                  <i class="fas fa-box-open fa-3x mb-3 text-secondary opacity-25"></i>
                  <p>No se encontraron productos</p>
                  <button class="btn btn-outline-primary btn-sm" @click="searchQuery = ''">
                    Limpiar b√∫squeda
                  </button>
                </td>
              </tr>

            </tbody>

          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<style>
  .scanner-container {
    width: 200px;
    height: 200px;
    overflow: hidden;
    border-radius: 12px;
    background: black;
    border: 2px solid #555;
    position: relative;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
  }

  #reader {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }

  #reader video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 12px;
  }
  
  .product-row {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .product-row:hover:not(.table-danger) {
    background-color: #f8f9fa !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  
  .btn-success, .btn-primary {
    transition: all 0.3s ease;
  }
  
  .btn-success:hover, .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  /* Centrado perfecto de iconos */
  .btn i {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
  }
  
  .rounded-circle {
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  function salesPOS() {
    return {
      searchQuery: '',
      products: [],
      cart: [],
      scanCooldown: false,
      processing: false,
      loading: true,
      scannerActive: false,
      html5QrCode: null,

      async init() {
        await this.loadProducts();
        this.startScanner();
      },

      async loadProducts() {
        this.loading = true;
        try {
          const response = await fetch('/api/inventory');
          if (response.ok) {
            this.products = await response.json();
          } else {
            console.error("Error al cargar inventario");
            this.products = [];
          }
        } catch (e) {
          console.error("Error de conexi√≥n", e);
        } finally {
          this.loading = false;
        }
      },

      async startScanner() {
        if (this.html5QrCode) {
          try {
            await this.html5QrCode.stop();
            await this.html5QrCode.clear();
          } catch (err) { console.log(err); }
        }

        this.html5QrCode = new Html5Qrcode("reader");

        const onScanSuccess = (decodedText, decodedResult) => {
          if (this.scanCooldown) return;

          let code = decodedText.trim();
          let product = this.products.find(p => p.sku === code);

          if (product) {
            this.addToCart(product);
            this.showFeedback(`‚úÖ ${product.name}`, 'bg-success');
            this.scanCooldown = true;
            setTimeout(() => this.scanCooldown = false, 1500);
          } else {
            this.showFeedback(`‚ùå No encontrado: ${code}`, 'bg-danger');
            this.scanCooldown = true;
            setTimeout(() => this.scanCooldown = false, 2000);
          }
        };

        const config = { fps: 10, qrbox: { width: 180, height: 180 }, aspectRatio: 1.0 };

        this.html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
          .then(() => { this.scannerActive = true; })
          .catch(err => {
            console.error("Error iniciando c√°mara", err);
            this.scannerActive = false;
          });
      },

      filteredProducts() {
        if (this.searchQuery === '') return this.products;
        const q = this.searchQuery.toLowerCase();
        return this.products.filter(p =>
          p.name.toLowerCase().includes(q) ||
          (p.sku && p.sku.includes(q))
        );
      },

      addToCart(product) {
        if (product.stock <= 0) {
          this.showFeedback('‚ö†Ô∏è Sin Stock', 'bg-warning text-dark');
          return;
        }

        let existing = this.cart.find(item => item.id === product.id);
        if (existing) {
          if (existing.qty < product.stock) {
            existing.qty++;
            this.showFeedback(`‚ûï ${product.name}`, 'bg-success');
          } else {
            this.showFeedback('‚ö†Ô∏è Stock Insuficiente', 'bg-warning text-dark');
          }
        } else {
          this.cart.push({
            id: product.id,
            name: product.name,
            price: product.price,
            qty: 1,
            stock: product.stock
          });
          this.showFeedback(`üõí ${product.name} agregado`, 'bg-success');
        }
      },

      updateQty(index, change) {
        let item = this.cart[index];
        let newQty = item.qty + change;
        if (newQty > item.stock) {
          this.showFeedback('‚ö†Ô∏è M√°ximo stock', 'bg-warning text-dark');
          return;
        }
        if (newQty > 0) {
          item.qty = newQty;
          this.showFeedback(change > 0 ? `‚ûï ${item.name}` : `‚ûñ ${item.name}`, 'bg-info');
        } else {
          this.removeItem(index);
        }
      },
      
      removeItem(index) {
        let item = this.cart[index];
        this.cart.splice(index, 1);
        this.showFeedback(`üóëÔ∏è ${item.name} eliminado`, 'bg-secondary');
      },

      totalCart() {
        return this.cart.reduce((acc, item) => acc + (item.price * item.qty), 0).toFixed(2);
      },

      showFeedback(msg, bgClass) {
        const el = document.getElementById('scan-message');
        el.innerHTML = `<span class="badge ${bgClass} p-2 fs-6 shadow">${msg}</span>`;
        el.style.display = 'block';
        setTimeout(() => { el.style.display = 'none'; }, 2000);
      },
      
      focusSearch() {
        document.getElementById('product-search').focus();
      },

      manualAdd() {
        let filtered = this.filteredProducts();
        if (filtered.length === 1) {
          this.addToCart(filtered[0]);
          this.searchQuery = '';
        }
      },

      async checkout() {
        this.processing = true;
        try {
          let res = await fetch('/api/checkout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              items: this.cart,
              customer: "Cliente Mostrador",
              payment_method: "cash"
            })
          });

          if (res.ok) {
            let data = await res.json();
            this.showCheckoutSuccess(data);
            await this.loadProducts();
            this.cart = [];
          } else {
            alert("Error al procesar venta");
          }
        } catch (e) {
          alert("Error de conexi√≥n");
        } finally {
          this.processing = false;
        }
      },
      
      showCheckoutSuccess(data) {
        const total = (this.totalCart() * 1.16).toFixed(2);
        const itemsCount = this.cart.reduce((a, b) => a + b.qty, 0);
        
        Swal.fire({
          title: '¬°Venta Exitosa!',
          html: `
            <div class="text-start">
              <p><strong>Recibo ID:</strong> ${data.receipt_id}</p>
              <p><strong>Art√≠culos:</strong> ${itemsCount}</p>
              <p><strong>Total:</strong> $${total}</p>
              <p><strong>Fecha:</strong> ${new Date().toLocaleString()}</p>
            </div>
          `,
          icon: 'success',
          confirmButtonText: 'Aceptar',
          confirmButtonColor: '#0d6efd'
        });
      }
    }
  }
</script>
{% endblock %}