</div>

<!-- Scanner Section -->
<div class="scanner-section"
  style="margin-bottom: 1.5rem; background: black; border-radius: 0.5rem; overflow: hidden; position: relative;">
  <div id="reader" style="width: 100%; min-height: 250px;"></div>
  <div id="scan-status"
    style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; padding: 0.5rem; text-align: center; display: none;">
    <i class="fas fa-check-circle"></i> Producto agregado
  </div>
</div>

<!-- Barra de búsqueda mejorada -->
<div class="search-bar" style="margin-bottom: 1.5rem;">
  <div class="form-group" style="position: relative;">
    <label><i class="fas fa-search"></i> Buscar Producto</label>
    <input class="form-control" placeholder="Buscar por nombre o código..." x-model="q" style="padding-left: 2.5rem;"
      @keydown.enter="if(filtered().length === 1) add(filtered()[0])">
    <i class="fas fa-search" style="position: absolute; left: 1rem; top: 2.75rem; color: var(--gray-400);"></i>
  </div>
</div>

<!-- Tabla de productos con mejor diseño -->
<div class="table-container" style="margin-bottom: 1.5rem;">
  <table>
    <thead>
      <tr>
        <th>Producto</th>
        <th>Precio</th>
        <th>Stock</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <template x-for="p in filtered()" :key="p.id">
        <tr>
          <td>
            <div x-text="p.name" style="font-weight: 500;"></div>
            <small x-text="p.sku" style="color: var(--gray-500);"></small>
          </td>
          <td>
            <div class="price" style="color: var(--primary); font-weight: 600;">
              $ <span x-text="p.price.toFixed(2)"></span>
            </div>
          </td>
          <td>
            <span class="status"
              :class="p.stock > 10 ? 'status-success' : (p.stock > 0 ? 'status-warning' : 'status-danger')"
              x-text="p.stock"></span>
          </td>
          <td>
            <button class="btn btn-primary" @click="add(p)" :disabled="p.stock <= 0"
              :title="p.stock <= 0 ? 'Sin stock disponible' : 'Agregar al carrito'">
              <i class="fas fa-plus"></i>
              <span x-show="p.stock > 0">Agregar</span>
              <span x-show="p.stock <= 0">Sin Stock</span>
            </button>
          </td>
        </tr>
      </template>
    </tbody>
  </table>
</div>
</div>

<!-- Panel derecho: Carrito y checkout -->
<div class="cart-panel" style="display: flex; flex-direction: column; gap: 1rem;">
  <!-- Carrito -->
  <div class="content-section">
    <div class="section-header" style="margin-bottom: 1rem;">
      <h2><i class="fas fa-shopping-cart"></i> Carrito</h2>
      <button class="btn btn-secondary" @click="clearCart()" x-show="cart.length > 0">
        <i class="fas fa-trash-alt"></i> Vaciar
      </button>
    </div>

    <div x-show="cart.length === 0" style="text-align: center; padding: 2rem; color: var(--gray-500);">
      <i class="fas fa-shopping-cart" style="font-size: 2rem; margin-bottom: 1rem;"></i>
      <p>El carrito está vacío</p>
    </div>

    <template x-if="cart.length > 0">
      <div class="cart-items" style="margin-bottom: 1rem;">
        <template x-for="(it, idx) in cart" :key="it.id">
          <div class="cart-item"
            style="display: flex; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--gray-200);">
            <div style="flex: 1;">
              <div x-text="it.name" style="font-weight: 500;"></div>
              <div style="color: var(--primary); font-size: 0.875rem;">
                $ <span x-text="it.price.toFixed(2)"></span>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <input class="form-control" type="number" min="1" :max="getMaxStock(it.id)" x-model.number="it.qty"
                style="width: 5rem;">
              <button class="btn btn-secondary" @click="remove(idx)">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </template>
      </div>
    </template>
  </div>

  <!-- Resumen y checkout -->
  <div class="content-section" x-show="cart.length > 0">
    <div style="margin-bottom: 1rem;">
      <div class="form-group">
        <label><i class="fas fa-user"></i> Cliente (opcional)</label>
        <input class="form-control" x-model="customerName" placeholder="Nombre del cliente">
      </div>
      <div class="form-group">
        <label><i class="fas fa-money-bill"></i> Método de Pago</label>
        <select class="form-control" x-model="paymentMethod">
          <option value="cash">Efectivo</option>
          <option value="card">Tarjeta</option>
        </select>
      </div>
    </div>

    <div class="total-section"
      style="background: var(--gray-50); padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
      <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
        <span>Subtotal:</span>
        <span>$ <span x-text="total().toFixed(2)"></span></span>
      </div>
      <div
        style="display: flex; justify-content: space-between; font-size: 1.25rem; font-weight: 600; color: var(--primary);">
        <span>Total:</span>
        <span>$ <span x-text="total().toFixed(2)"></span></span>
      </div>
    </div>

    <button class="btn btn-primary" style="width: 100%;" @click="checkout()" :disabled="processing">
      <i class="fas fa-check"></i>
      <span x-text="processing ? 'Procesando...' : 'Finalizar Venta'"></span>
    </button>
  </div>
</div>
</div>

<!-- Modal de Confirmación de Venta -->
<div x-show="showConfirm"
  style="position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50;">
  <div class="content-section" style="width: 100%; max-width: 480px; margin: 1rem;"
    @click.outside="showConfirm = false">
    <h3 style="margin-bottom: 1rem;">
      <i class="fas fa-check-circle" style="color: var(--secondary);"></i>
      Venta Exitosa
    </h3>
    <p>La venta se ha procesado correctamente.</p>
    <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
      <button class="btn btn-secondary" @click="showConfirm = false">
        <i class="fas fa-cart-plus"></i> Nueva Venta
      </button>
      <a :href="'/receipt/' + lastReceiptId" class="btn btn-primary">
        <i class="fas fa-print"></i> Ver Recibo
      </a>
    </div>
  </div>
</div>
</div>
{% endblock %}
{% block scripts %}
<script>
  // Inject server-side products into a global used by the static script
  window.INIT_PRODUCTS = {{ products | tojson | safe }};
</script>
<script src="{{ url_for('static', filename='js/sales.js') }}"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  // Scanner Logic
  document.addEventListener('DOMContentLoaded', function () {
    const html5QrCode = new Html5Qrcode("reader");
    const config = { fps: 10, qrbox: { width: 250, height: 250 } };

    // Sound effect
    const beep = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

    const onScanSuccess = (decodedText, decodedResult) => {
      // Prevent duplicate rapid scans of the same item if needed, 
      // but for supermarket style we usually want to allow it.
      // We'll add a small throttle to prevent double-reading the exact same frame.

      // Visual feedback
      const status = document.getElementById('scan-status');
      status.innerHTML = `<i class="fas fa-check-circle"></i> ${product.name} agregado`;
      status.style.display = 'block';
      status.style.background = 'rgba(16, 185, 129, 0.9)'; // Green
      setTimeout(() => status.style.display = 'none', 2000);
    } else {
      // Out of stock feedback
      const status = document.getElementById('scan-status');
    status.innerHTML = `<i class="fas fa-exclamation-circle"></i> Sin stock: ${product.name}`;
    status.style.display = 'block';
    status.style.background = 'rgba(239, 68, 68, 0.9)'; // Red
    setTimeout(() => status.style.display = 'none', 2000);
  }
      } else {
      // Not found feedback
      const status = document.getElementById('scan-status');
      status.innerHTML = `<i class="fas fa-question-circle"></i> Producto no encontrado`;
      status.style.display = 'block';
      status.style.background = 'rgba(245, 158, 11, 0.9)'; // Orange
      setTimeout(() => status.style.display = 'none', 2000);
      }
    };

  html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
    .catch(err => {
      console.error("Error starting scanner", err);
      document.getElementById('reader').innerHTML =
        '<div style="color:white; padding:2rem; text-align:center;">' +
        '<i class="fas fa-camera-slash" style="font-size:2rem; margin-bottom:1rem;"></i><br>' +
        'No se pudo acceder a la cámara.<br>Verifique los permisos.</div>';
    });
  });
</script>
<link rel="stylesheet" href="{{ url_for('static', filename='css/sales.css') }}">
{% endblock %}